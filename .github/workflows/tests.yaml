name: Test Suite

on:
    push:
        branches: ["master", "v1", "mysql_engine"]
        paths-ignore:
            - "docs/**"
    pull_request:
        branches: ["master", "v1"]
        paths-ignore:
            - "docs/**"

jobs:
    mysql:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.10", "3.11", "3.12", "3.13"]

        services:
            mysql:
                image: mysql:8.4
                env:
                    MYSQL_ROOT_PASSWORD: rootpassword
                options: >-
                    --health-cmd="mysqladmin ping -uroot -prootpassword" 
                    --health-interval=5s 
                    --health-timeout=2s 
                    --health-retries=3

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements/requirements.txt
                  pip install -r requirements/test-requirements.txt
                  pip install -r requirements/extras/mysql.txt 
            - name: Wait for MySQL
              run: |
                  for i in {1..40}; do
                    mysqladmin ping -hmysql -uroot -prootpassword && break
                    echo "Waiting for MySQLâ€¦ ($i/40)"
                    sleep 2
                    if [ "$i" -eq 40 ]; then
                        echo "MySQL did not become ready in time!" >&2
                        exit 1
                    fi
                  done     
            - name: Setup MySQL
              run: |
                  mysql -hmysql -uroot -prootpassword -e "CREATE DATABASE piccolo"
         
            - name: Test with pytest, MySQL
              run: ./scripts/test-mysql.sh
        
            - name: Upload coverage
              uses: codecov/codecov-action@v1
              if: matrix.python-version == '3.13'
